import React, { useState, useEffect } from 'react';
import { useFile } from '../contexts/FileContext';
import { useWorkspace } from '../contexts/WorkspaceContext';
import { useNotification } from './NotificationProvider';
import FileTree from './FileTree';
import FileSelector from './FileSelector';
import './FilePanel.css';

const FilePanel: React.FC = () => {
  const { 
    files, 
    isLoading, 
    error, 
    createFile, 
    createFolder, 
    refreshFileTree 
  } = useFile();
  const { currentWorkspace } = useWorkspace();
  const { showSuccess, showError, showWarning, showInfo } = useNotification();
  
  const [showNewFileDialog, setShowNewFileDialog] = useState(false);
  const [showNewFolderDialog, setShowNewFolderDialog] = useState(false);
  const [showExportFilesDialog, setShowExportFilesDialog] = useState(false);
  const [showExportImageDialog, setShowExportImageDialog] = useState(false);
  const [newFileName, setNewFileName] = useState('');
  const [newFolderName, setNewFolderName] = useState('');
  
  // ÂØºÂá∫Áõ∏ÂÖ≥Áä∂ÊÄÅ
  const [exportPath, setExportPath] = useState('');
  const [exportFormat, setExportFormat] = useState('zip');
  const [imageName, setImageName] = useState('');
  const [imageTag, setImageTag] = useState('');
  const [isExporting, setIsExporting] = useState(false);
  const [selectedFiles, setSelectedFiles] = useState<string[]>([]);
  const [exportMode, setExportMode] = useState<'all' | 'path' | 'selected'>('all');

  // ÁõëÂê¨Â∑•‰ΩúÁ©∫Èó¥ÂèòÂåñÔºåÊèê‰æõÁî®Êà∑ÂèçÈ¶à
  useEffect(() => {
    if (currentWorkspace) {
      console.log('üîÑ FilePanel: Â∑•‰ΩúÁ©∫Èó¥Â∑≤ÂàáÊç¢Âà∞', currentWorkspace);
      // ÈáçÁΩÆÂØºÂá∫Ë°®Âçï
      setExportPath('');
      setImageName(`exported_${currentWorkspace}`);
      setImageTag('latest');
      setSelectedFiles([]);
      setExportMode('all');
    }
  }, [currentWorkspace]);

  const handleRefresh = async () => {
    if (!currentWorkspace) {
      showWarning('Êìç‰ΩúÂèóÈôê', 'ËØ∑ÂÖàÈÄâÊã©Â∑•‰ΩúÁ©∫Èó¥');
      return;
    }
    showInfo('Âà∑Êñ∞‰∏≠', 'Ê≠£Âú®Âà∑Êñ∞Êñá‰ª∂Ê†ë...');
    await refreshFileTree();
  };

  const handleNewFile = async () => {
    if (!newFileName.trim()) return;
    
    try {
      await createFile(newFileName.trim());
      setNewFileName('');
      setShowNewFileDialog(false);
      showSuccess('ÂàõÂª∫ÊàêÂäü', 'Êñá‰ª∂ÂàõÂª∫ÊàêÂäüÔºÅ');
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ';
      showError('ÂàõÂª∫Â§±Ë¥•', `ÂàõÂª∫Êñá‰ª∂Â§±Ë¥•: ${errorMessage}`);
    }
  };

  const handleNewFolder = async () => {
    if (!newFolderName.trim()) return;
    
    try {
      await createFolder(newFolderName.trim());
      setNewFolderName('');
      setShowNewFolderDialog(false);
      showSuccess('ÂàõÂª∫ÊàêÂäü', 'Êñá‰ª∂Â§πÂàõÂª∫ÊàêÂäüÔºÅ');
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ';
      showError('ÂàõÂª∫Â§±Ë¥•', `ÂàõÂª∫Êñá‰ª∂Â§πÂ§±Ë¥•: ${errorMessage}`);
    }
  };

  // ÂØºÂá∫Â∑•‰ΩúÁ©∫Èó¥Êñá‰ª∂
  const handleExportFiles = async () => {
    if (!currentWorkspace) return;
    
    // È™åËØÅÈÄâÊã©Ê®°Âºè
    if (exportMode === 'selected' && selectedFiles.length === 0) {
      showWarning('ÈÄâÊã©ÈîôËØØ', 'ËØ∑ÈÄâÊã©Ë¶ÅÂØºÂá∫ÁöÑÊñá‰ª∂ÊàñÊñá‰ª∂Â§π');
      return;
    }
    
    setIsExporting(true);
    try {
      const exportData: any = {
        type: 'files',
        format: exportFormat,
      };

      // Ê†πÊçÆÂØºÂá∫Ê®°ÂºèËÆæÁΩÆÂèÇÊï∞
      if (exportMode === 'path') {
        exportData.path = exportPath.trim();
      } else if (exportMode === 'selected') {
        exportData.selected_files = selectedFiles;
      }
      // 'all' Ê®°Âºè‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÂèÇÊï∞

      const response = await fetch(`/api/v1/workspaces/${currentWorkspace}/export`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(exportData),
      });

      if (!response.ok) {
        throw new Error(`ÂØºÂá∫Â§±Ë¥•: ${response.status}`);
      }

      const result = await response.json();
      
      if (result.success) {
        // Ëß¶Âèë‰∏ãËΩΩ
        const downloadUrl = `/api/v1/downloads/${result.download_id}/file`;
        window.open(downloadUrl, '_blank');
        
        setShowExportFilesDialog(false);
        setExportPath('');
        setSelectedFiles([]);
        showSuccess('ÂØºÂá∫ÊàêÂäü', 'Êñá‰ª∂ÂØºÂá∫ÊàêÂäüÔºå‰∏ãËΩΩÂ∑≤ÂºÄÂßãÔºÅ');
        
      } else {
        throw new Error(result.message || 'ÂØºÂá∫Â§±Ë¥•');
      }
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'ÂØºÂá∫Â§±Ë¥•';
      showError('ÂØºÂá∫Â§±Ë¥•', `ÂØºÂá∫Â§±Ë¥•: ${errorMessage}`);
      console.error('Êñá‰ª∂ÂØºÂá∫Â§±Ë¥•:', error);
    } finally {
      setIsExporting(false);
    }
  };

  // ÂØºÂá∫Â∑•‰ΩúÁ©∫Èó¥ÈïúÂÉè
  const handleExportImage = async () => {
    if (!currentWorkspace) return;
    
    setIsExporting(true);
    try {
      const response = await fetch(`/api/v1/workspaces/${currentWorkspace}/export`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          type: 'image',
          image_name: imageName.trim() || `exported_${currentWorkspace}`,
          image_tag: imageTag.trim() || 'latest',
        }),
      });

      if (!response.ok) {
        throw new Error(`ÂØºÂá∫Â§±Ë¥•: ${response.status}`);
      }

      const result = await response.json();
      
      if (result.success) {
        // Ëß¶Âèë‰∏ãËΩΩ
        const downloadUrl = `/api/v1/downloads/${result.download_id}/file`;
        window.open(downloadUrl, '_blank');
        
        setShowExportImageDialog(false);
        showSuccess('ÂØºÂá∫ÊàêÂäü', 'ÈïúÂÉèÂØºÂá∫ÊàêÂäüÔºå‰∏ãËΩΩÂ∑≤ÂºÄÂßãÔºÅ');
      } else {
        throw new Error(result.message || 'ÂØºÂá∫Â§±Ë¥•');
      }
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'ÂØºÂá∫Â§±Ë¥•';
      showError('ÂØºÂá∫Â§±Ë¥•', `ÈïúÂÉèÂØºÂá∫Â§±Ë¥•: ${errorMessage}`);
      console.error('ÈïúÂÉèÂØºÂá∫Â§±Ë¥•:', error);
    } finally {
      setIsExporting(false);
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent, action: () => void) => {
    if (e.key === 'Enter') {
      action();
    } else if (e.key === 'Escape') {
      setShowNewFileDialog(false);
      setShowNewFolderDialog(false);
      setShowExportFilesDialog(false);
      setShowExportImageDialog(false);
      setNewFileName('');
      setNewFolderName('');
    }
  };

  return (
    <div className="file-panel">
      <div className="file-toolbar">
        <button 
          className="btn btn-sm" 
          title="Âà∑Êñ∞Êñá‰ª∂ÂàóË°®" 
          onClick={handleRefresh}
          disabled={!currentWorkspace}
        >
          <i className="fas fa-sync"></i>
        </button>
        <button 
          className="btn btn-sm" 
          title="Êñ∞Âª∫Êñá‰ª∂"
          onClick={() => setShowNewFileDialog(true)}
          disabled={!currentWorkspace}
        >
          <i className="fas fa-file"></i>
        </button>
        <button 
          className="btn btn-sm" 
          title="Êñ∞Âª∫Êñá‰ª∂Â§π"
          onClick={() => setShowNewFolderDialog(true)}
          disabled={!currentWorkspace}
        >
          <i className="fas fa-folder-plus"></i>
        </button>
        
        <div className="toolbar-divider"></div>
        
        <button 
          className="btn btn-sm btn-export" 
          title="ÂØºÂá∫Â∑•‰ΩúÁ©∫Èó¥Êñá‰ª∂"
          onClick={() => setShowExportFilesDialog(true)}
          disabled={!currentWorkspace || isExporting}
        >
          <i className="fas fa-download"></i>
        </button>
        <button 
          className="btn btn-sm btn-export" 
          title="ÂØºÂá∫Â∑•‰ΩúÁ©∫Èó¥ÈïúÂÉè"
          onClick={() => setShowExportImageDialog(true)}
          disabled={!currentWorkspace || isExporting}
        >
          <i className="fab fa-docker"></i>
        </button>
      </div>

      {/* Êñ∞Âª∫Êñá‰ª∂ÂØπËØùÊ°Ü */}
      {showNewFileDialog && (
        <div className="dialog-overlay" onClick={() => setShowNewFileDialog(false)}>
          <div className="dialog-content" onClick={(e) => e.stopPropagation()}>
            <h3>Êñ∞Âª∫Êñá‰ª∂</h3>
            <input
              type="text"
              placeholder="ËæìÂÖ•Êñá‰ª∂ÂêçÔºàÂåÖÂê´Êâ©Â±ïÂêçÔºâ"
              value={newFileName}
              onChange={(e) => setNewFileName(e.target.value)}
              onKeyDown={(e) => handleKeyPress(e, handleNewFile)}
              autoFocus
            />
            <div className="dialog-actions">
              <button onClick={handleNewFile} disabled={!newFileName.trim()}>
                ÂàõÂª∫
              </button>
              <button onClick={() => setShowNewFileDialog(false)}>
                ÂèñÊ∂à
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Êñ∞Âª∫Êñá‰ª∂Â§πÂØπËØùÊ°Ü */}
      {showNewFolderDialog && (
        <div className="dialog-overlay" onClick={() => setShowNewFolderDialog(false)}>
          <div className="dialog-content" onClick={(e) => e.stopPropagation()}>
            <h3>Êñ∞Âª∫Êñá‰ª∂Â§π</h3>
            <input
              type="text"
              placeholder="ËæìÂÖ•Êñá‰ª∂Â§πÂêç"
              value={newFolderName}
              onChange={(e) => setNewFolderName(e.target.value)}
              onKeyDown={(e) => handleKeyPress(e, handleNewFolder)}
              autoFocus
            />
            <div className="dialog-actions">
              <button onClick={handleNewFolder} disabled={!newFolderName.trim()}>
                ÂàõÂª∫
              </button>
              <button onClick={() => setShowNewFolderDialog(false)}>
                ÂèñÊ∂à
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ÂØºÂá∫Êñá‰ª∂ÂØπËØùÊ°Ü */}
      {showExportFilesDialog && (
        <div className="dialog-overlay" onClick={() => setShowExportFilesDialog(false)}>
          <div className="dialog-content export-dialog large-dialog" onClick={(e) => e.stopPropagation()}>
            <h3><i className="fas fa-download"></i> ÂØºÂá∫Â∑•‰ΩúÁ©∫Èó¥Êñá‰ª∂</h3>
            
            <div className="form-group">
              <label className="form-label">ÂØºÂá∫Ê®°Âºè</label>
              <div className="radio-group">
                <label className="radio-option">
                  <input
                    type="radio"
                    value="all"
                    checked={exportMode === 'all'}
                    onChange={(e) => setExportMode(e.target.value as any)}
                  />
                  <span>ÂØºÂá∫Êï¥‰∏™Â∑•‰ΩúÁ©∫Èó¥</span>
                </label>
                <label className="radio-option">
                  <input
                    type="radio"
                    value="path"
                    checked={exportMode === 'path'}
                    onChange={(e) => setExportMode(e.target.value as any)}
                  />
                  <span>ÂØºÂá∫ÊåáÂÆöË∑ØÂæÑ</span>
                </label>
                <label className="radio-option">
                  <input
                    type="radio"
                    value="selected"
                    checked={exportMode === 'selected'}
                    onChange={(e) => setExportMode(e.target.value as any)}
                  />
                  <span>ÈÄâÊã©Êñá‰ª∂ÂØºÂá∫</span>
                </label>
              </div>
            </div>

            {exportMode === 'path' && (
              <div className="form-group">
                <label className="form-label">ÂØºÂá∫Ë∑ØÂæÑ</label>
                <input
                  type="text"
                  placeholder="ËæìÂÖ•Ë¶ÅÂØºÂá∫ÁöÑË∑ØÂæÑÔºåÂ¶Ç 'src' Êàñ 'docs/images'"
                  value={exportPath}
                  onChange={(e) => setExportPath(e.target.value)}
                />
                <small>‰æãÂ¶ÇÔºösrc„ÄÅdocs/images„ÄÅcomponents</small>
              </div>
            )}

            {exportMode === 'selected' && (
              <div className="form-group">
                <label className="form-label">ÈÄâÊã©Êñá‰ª∂ÂíåÊñá‰ª∂Â§π</label>
                <div className="file-selector-container">
                  <FileSelector
                    selectedFiles={selectedFiles}
                    onSelectionChange={setSelectedFiles}
                  />
                </div>
              </div>
            )}

            <div className="form-group">
              <label className="form-label">ÂéãÁº©Ê†ºÂºè</label>
              <div className="radio-group">
                <label className="radio-option">
                  <input
                    type="radio"
                    value="zip"
                    checked={exportFormat === 'zip'}
                    onChange={(e) => setExportFormat(e.target.value)}
                  />
                  <span>ZIPÊ†ºÂºèÔºàÊé®ËçêÔºâ</span>
                </label>
                <label className="radio-option">
                  <input
                    type="radio"
                    value="tar.gz"
                    checked={exportFormat === 'tar.gz'}
                    onChange={(e) => setExportFormat(e.target.value)}
                  />
                  <span>tar.gzÊ†ºÂºè</span>
                </label>
              </div>
            </div>

            <div className="dialog-actions">
              <button 
                onClick={handleExportFiles} 
                disabled={isExporting || (exportMode === 'selected' && selectedFiles.length === 0)}
                className="btn-primary"
              >
                {isExporting ? (
                  <>
                    <i className="fas fa-spinner fa-spin"></i>
                    ÂØºÂá∫‰∏≠...
                  </>
                ) : (
                  <>
                    <i className="fas fa-download"></i>
                    ÂºÄÂßãÂØºÂá∫
                  </>
                )}
              </button>
              <button 
                onClick={() => {
                  setShowExportFilesDialog(false);
                  setSelectedFiles([]);
                  setExportMode('all');
                }} 
                disabled={isExporting}
              >
                ÂèñÊ∂à
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ÂØºÂá∫ÈïúÂÉèÂØπËØùÊ°Ü */}
      {showExportImageDialog && (
        <div className="dialog-overlay" onClick={() => setShowExportImageDialog(false)}>
          <div className="dialog-content export-dialog" onClick={(e) => e.stopPropagation()}>
            <h3><i className="fab fa-docker"></i> ÂØºÂá∫Â∑•‰ΩúÁ©∫Èó¥ÈïúÂÉè</h3>
            
            <div className="form-group">
              <label className="form-label">ÈïúÂÉèÂêçÁß∞</label>
              <input
                type="text"
                placeholder="ÈïúÂÉèÂêçÁß∞"
                value={imageName}
                onChange={(e) => setImageName(e.target.value)}
              />
              <small>‰æãÂ¶ÇÔºömy-project„ÄÅfrontend-app</small>
            </div>

            <div className="form-group">
              <label className="form-label">ÈïúÂÉèÊ†áÁ≠æ</label>
              <input
                type="text"
                placeholder="ÈïúÂÉèÊ†áÁ≠æ"
                value={imageTag}
                onChange={(e) => setImageTag(e.target.value)}
              />
              <small>‰æãÂ¶ÇÔºölatest„ÄÅv1.0„ÄÅdev</small>
            </div>

            <div className="export-info">
              <i className="fas fa-info-circle"></i>
              <div>
                <strong>ËØ¥ÊòéÔºö</strong>
                <p>Â∞ÜÊääÂΩìÂâçÂÆπÂô®ÁöÑÂÆåÊï¥Áä∂ÊÄÅ‰øùÂ≠ò‰∏∫DockerÈïúÂÉèÔºåÂåÖÊã¨Â∑≤ÂÆâË£ÖÁöÑËΩØ‰ª∂„ÄÅÈÖçÁΩÆÂíåÊâÄÊúâÊñá‰ª∂„ÄÇÁîüÊàêÁöÑÈïúÂÉèÊñá‰ª∂ÂèØ‰ª•Âú®ÂÖ∂‰ªñDockerÁéØÂ¢É‰∏≠ÂØºÂÖ•‰ΩøÁî®„ÄÇ</p>
              </div>
            </div>

            <div className="dialog-actions">
              <button 
                onClick={handleExportImage} 
                disabled={isExporting}
                className="btn-primary"
              >
                {isExporting ? (
                  <>
                    <i className="fas fa-spinner fa-spin"></i>
                    ÂØºÂá∫‰∏≠...
                  </>
                ) : (
                  <>
                    <i className="fab fa-docker"></i>
                    ÂºÄÂßãÂØºÂá∫
                  </>
                )}
              </button>
              <button onClick={() => setShowExportImageDialog(false)} disabled={isExporting}>
                ÂèñÊ∂à
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="file-tree">
        {isLoading ? (
          <div className="file-tree-loading">
            <i className="fas fa-spinner fa-spin"></i>
            <div>Âä†ËΩΩ‰∏≠...</div>
          </div>
        ) : error ? (
          <div className="file-tree-error">
            <i className="fas fa-exclamation-triangle"></i>
            <div>{error}</div>
          </div>
        ) : !currentWorkspace ? (
          <div className="file-tree-empty">
            <i className="fas fa-folder-open"></i>
            <div>ËØ∑ÂÖàÈÄâÊã©Â∑•‰ΩúÁ©∫Èó¥</div>
          </div>
        ) : !files || files.length === 0 ? (
          <div className="file-tree-empty">
            <i className="fas fa-folder-open"></i>
            <div>ÂΩìÂâçÁõÆÂΩï‰∏∫Á©∫</div>
            <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginTop: '8px' }}>
              ÁÇπÂáª‰∏äÊñπÊåâÈíÆÂàõÂª∫Êñá‰ª∂ÊàñÊñá‰ª∂Â§π
            </div>
          </div>
        ) : (
          <FileTree />
        )}
      </div>
    </div>
  );
};

export default FilePanel; 